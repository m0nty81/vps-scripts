# VPS Deploy Bash

Базовая настройка VPS (Debian/Ubuntu) с использованием bash скриптов.

## Возможности

- ✅ Обновление системы (`apt update` всегда, `apt upgrade` опционально)
- ✅ Создание нового пользователя с sudo правами
- ✅ Настройка SSH (порт, ключи, безопасность)
- ✅ Настройка firewall (UFW)
- ✅ Интерактивный диалоговый режим
- ✅ Логирование всех действий
- ✅ Идемпотентность (безопасный повторный запуск)
- ✅ Генерация SSH ключей на сервере
- ✅ Поддержка Debian 11, 12 и Ubuntu 20.04, 22.04, 24.04

## Поддерживаемые ОС

| ОС | Версии |
|----|--------|
| Debian | 11, 12 |
| Ubuntu | 20.04, 22.04, 24.04 |

## Быстрый старт

### Вариант 1: Запуск через curl (рекомендуется)

```bash
curl -sL https://raw.githubusercontent.com/m0nty81/vps-scripts/main/scripts/install.sh | sudo bash
```

### Вариант 2: Клонирование репозитория

```bash
# Клонировать репозиторий
git clone https://github.com/m0nty81/vps-scripts.git /tmp/vps-deploy
cd /tmp/vps-deploy

# Запустить скрипт настройки
sudo ./bin/deploy.sh
```

## Диалог настройки

Скрипт задаст следующие вопросы:

| Вопрос | Описание |
|--------|----------|
| Обновление системы | Выполнить `apt update` и опционально `apt upgrade` |
| Создать пользователя | Создать нового пользователя с sudo правами |
| Метод аутентификации | SSH ключ (импорт/генерация) или пароль |
| Порт SSH | Указать порт для SSH (диапазон 1-65535) |
| Включить firewall | Настроить и включить UFW |
| Применить настройки | Подтверждение перед внесением изменений |

## Пример диалога

```
╔═══════════════════════════════════════════════════════════╗
║         VPS Deploy Script - Базовая настройка             ║
╚═══════════════════════════════════════════════════════════╝

[1/5] Выполнить обновление системы (apt update && apt upgrade)? [y/N]: n

[2/5] Создать нового пользователя? [y/N]: y
Введите имя нового пользователя:
Имя пользователя (латиница, 3-32 символа): admin

[2.1/5]
  1) SSH ключ (рекомендуется)
  2) Пароль
Ваш выбор (1-2): 1

[2.2/5]
  1) Вставить существующий публичный ключ
  2) Сгенерировать новые ключи на сервере
Ваш выбор (1-2): 2

[3/5] Укажите порт SSH (default: 22, диапазон: 1-65535): 2245

[4/5] Включить firewall (UFW)? [Y/n]: y

[5/5] Проверка параметров:
  • Обновление системы: false
  • Создание пользователя: true
    - Имя: admin
  • Порт SSH: 2245
  • Firewall: true

Применить настройки? [y/N]: y
```

## После настройки

### Сохранение приватного ключа

Если вы выбрали генерацию ключей на сервере, скрипт покажет приватный ключ.

**Важно:** Сохраните его в безопасном месте на локальной машине:

```bash
# 1. Создайте файл с ключом
nano ~/.ssh/vps_admin

# 2. Вставьте приватный ключ (включая BEGIN/END строки)

# 3. Установите правильные права
chmod 600 ~/.ssh/vps_admin

# 4. Подключайтесь к серверу
ssh -i ~/.ssh/vps_admin -p 2245 admin@your-server-ip
```

### Проверка подключения

**Не закрывайте текущую сессию SSH!** Откройте новую сессию в другом окне:

```bash
ssh -p 2245 admin@your-server-ip
```

Убедитесь что подключение работает, затем закройте старую сессию.

### Проверка статуса firewall

```bash
sudo ufw status verbose
```

### Просмотр лога настройки

```bash
sudo cat /var/log/vps-deploy.log
```

## Структура проекта

```
vps-scripts/
├── bin/
│   └── deploy.sh        # Основной скрипт настройки
├── lib/
│   ├── common.sh        # Общие функции (логирование, диалоги)
│   ├── os_utils.sh      # Утилиты ОС (определение, пакеты)
│   ├── ssh_utils.sh     # Настройка SSH
│   ├── user_utils.sh    # Управление пользователями
│   └── firewall_utils.sh # Настройка UFW
├── scripts/
│   └── install.sh       # Скрипт для установки через curl
├── config/
│   └── config.example.sh # Пример конфигурации
├── tests/
│   └── structure_test.sh # Тест структуры проекта
└── README.md
```

## Тестирование

Проверка структуры проекта:

```bash
./tests/structure_test.sh
```

Проверка синтаксиса скриптов:

```bash
bash -n bin/deploy.sh
bash -n lib/*.sh
```

## Требования

- **Права доступа**: запуск от root (`sudo`)
- **ОС**: Debian 11-12 или Ubuntu 20.04-24.04
- **Bash**: версия 4.0+

## Безопасность

Скрипт применяет следующие настройки безопасности:

| Настройка | Значение |
|-----------|----------|
| PermitRootLogin | no (или prohibit-password) |
| PasswordAuthentication | no (если выбран ключ) / yes (если выбран пароль) |
| PubkeyAuthentication | yes |
| MaxAuthTries | 3 |
| X11Forwarding | no |

### Backup SSH конфига

- Автоматически создается backup `/etc/ssh/sshd_config.backup.<timestamp>` перед изменениями
- При проблемах можно восстановить:

```bash
sudo cp /etc/ssh/sshd_config.backup.* /etc/ssh/sshd_config
sudo systemctl restart ssh
```

## Логирование

Все действия записываются в `/var/log/vps-deploy.log`

```bash
# Просмотр лога в реальном времени
sudo tail -f /var/log/vps-deploy.log
```

## Восстановление при проблемах

Если после настройки SSH что-то пошло не так:

1. **Не закрывайте активную сессию SSH**
2. Проверьте конфиг SSH:

   ```bash
   sudo sshd -t  # Проверка синтаксиса
   sudo cat /etc/ssh/sshd_config  # Просмотр конфига
   ```

3. Восстановите из backup:

   ```bash
   sudo cp /etc/ssh/sshd_config.backup.* /etc/ssh/sshd_config
   sudo systemctl restart ssh
   ```

## Примечания

### Ubuntu 24.04

На Ubuntu 24.04 скрипт автоматически отключает socket activation для SSH, чтобы смена порта работала корректно.

### Порты SSH

Поддерживаются любые порты в диапазоне 1-65535, включая стандартный порт 22.
